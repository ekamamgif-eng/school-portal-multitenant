# üìò CursorSchool Developer Guide

## üåü Overview
CursorSchool is a **Multi-Tenant SaaS Platform** built for educational institutions. It allows a single deployment to serve multiple schools, each with its own **branding**, **content**, **data**, and **domain**, all managed from a central codebase.

## üèóÔ∏è Architecture & Tech Stack

### Core Framework
- **Next.js 16 (App Router)**: Uses server components by default for performance.
- **TypeScript**: Strict type safety throughout the application.
- **Turbopack**: High-speed local development bundler.

### Authentication & Authorization
- **Clerk**: Handles User Management, Authentication (Sign-in/Sign-up), and Session Management.
- **Role-Based Access (RBAC)**:
    - **Super Admin**: Controls the entire platform (`/super-admin`). Identified by a specific email in environment variables.
    - **Tenant Admin**: Manages a specific school.
    - **Teacher/Student**: End-users (future implementation).

### Database
- **PostgreSQL (Neon)**: Serverless SQL database.
- **Drizzle ORM**: TypeScript-first ORM for type-safe database queries.
- **Schema Separation**:
    - `tenants`: Stores school config (slug, name).
    - `platform_settings`: Stores global config (branding, SEO) via JSONB columns for flexibility.

### Multi-Tenancy (The "Secret Sauce")
Routing is handled by `src/middleware.ts`.
1.  **Request comes in**: `school-a.cursorschool.com`
2.  **Middleware** detects subdomain: `school-a`
3.  **Rewrite**: The URL is rewritten to `/school-a/path` (e.g., `/school-a/dashboard`).
4.  **Codebase**: The logic lives in `src/app/(tenant)/[slug]/page.tsx`.
5.  **Result**: The user perceives they are on their own dedicated site.

---

## üõ†Ô∏è Key Systems

### 1. Super Admin CMS (`/super-admin`)
A protected dashboard for the platform owner to manage global settings.
- **Security**: Validates that the logged-in user's email matches `NEXT_PUBLIC_SUPER_ADMIN_EMAIL`.
- **Features**:
    - **Platform SEO**: Edit global meta tags and OG images.
    - **Branding**: Change the global logo, slogan, and theme colors.
    - **Modules**: Enable/Disable system-wide features.

### 2. Branding System
We use a hybrid approach for branding:
- **Database**: Stores `logoUrl` (supports raw SVG Data URIs!), `primaryColor`, `secondaryColor` in `platform_settings` or `tenants` table.
- **Injection**:
    - **Global**: `src/app/(public)/page.tsx` fetches branding and applies CSS variables (`--primary`, `--secondary`) to the root element.
    - **Tenant**: `TenantBrandingProvider` (to be fully implemented) injects styles based on the active tenant.

### 3. SEO System
- **Dynamic Metadata**: `generateMetadata()` functions in pages fetch SEO config from the DB.
- **OG Images**: Supports both hosted URLs and Base64 encoded SVGs for internal previews.

---

## üíª Local Development Workflow

### Prerequisites
- Node.js 20+
- PostgreSQL Database
- Clerk Account

### Environment Setup (`.env.local`)
```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_SUPER_ADMIN_EMAIL=your-email@example.com  <-- CRITICAL for Admin Access
DATABASE_URL=postgresql://...
```

### Running the App
```bash
npm install
npm run dev
```

### Accessing Subdomains Locally
You must modify your `/etc/hosts` (Mac/Linux) or `C:\Windows\System32\drivers\etc\hosts` (Windows):
```
127.0.0.1   local.cursorschool.test
127.0.0.1   demo.local.cursorschool.test
127.0.0.1   smpn1.local.cursorschool.test
```
Visit: `http://local.cursorschool.test:3000`

---

## üöÄ Deployment Guide (Netlify)

The project is optimized for Netlify deployment.

1.  **Configuration**: Uses `netlify.toml` to handle Next.js plugins and build settings.
2.  **Environment**: 
    - Ensure all keys from `.env.local` are added to Netlify Site Settings.
    - **Crucial**: Set `NEXT_PUBLIC_SUPER_ADMIN_EMAIL` in Netlify to enable your admin access in production.
3.  **Build Command**: `npm run build`
4.  **Output Directory**: `.next`

---

## üìù Common Tasks

### How to add a new Table?
1.  Edit `src/lib/db/schema.ts`.
2.  Run `npm run db:generate` to create the migration.
3.  Run `npm run db:push` to apply changes to Neon.

### How to debug specific issues?
- **Middleware**: Logs are intentionally minimized. Add `console.log` in `src/middleware.ts` if routing fails.
- **Auth**: Check the Browser Console for Clerk errors.
- **Database**: Use `npm run db:studio` to view your data visually.

---

*Generated by Antigravity AI - 2024*
